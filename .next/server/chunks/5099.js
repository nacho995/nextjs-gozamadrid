"use strict";exports.id=5099,exports.ids=[5099],exports.modules={15464:(e,o,t)=>{t.d(o,{d:()=>a});class r{constructor(){this.cache=new Map,this.lastFetch=null,this.isRefreshing=!1,this.CACHE_DURATION=3e5,this.STALE_DURATION=36e5}async getProperties(e=!1){let o=Date.now(),t=this.cache.get("woocommerce_properties");if(t&&!e){let e=o-t.timestamp;if(e<this.CACHE_DURATION)return console.log("‚úÖ WooCommerce: Devolviendo datos del cach\xe9 (frescos)"),t.data;if(e<this.STALE_DURATION)return console.log("‚ö° WooCommerce: Devolviendo datos del cach\xe9 (stale) y refrescando en segundo plano"),this.refreshInBackground(),t.data}try{return await this.fetchFromAPI()}catch(e){if(t)return console.log("‚ö†Ô∏è WooCommerce: Error en fetch, devolviendo datos antiguos del cach\xe9"),t.data;return console.error("‚ùå WooCommerce: Sin cach\xe9 y sin conexi\xf3n"),[]}}async fetchFromAPI(){for(let e=1;e<=3;e++)try{console.log(`üîÑ WooCommerce: Intento ${e}/3`);let o=new AbortController,t=setTimeout(()=>o.abort(),1e4),r=await fetch("/api/properties/sources/woocommerce?limit=100",{signal:o.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(t),!r.ok)throw Error(`HTTP ${r.status}`);let a=await r.json();return this.cache.set("woocommerce_properties",{data:Array.isArray(a)?a:[],timestamp:Date.now()}),console.log(`‚úÖ WooCommerce: ${a.length} propiedades cargadas y cacheadas`),a}catch(o){if(console.error(`‚ùå WooCommerce: Error en intento ${e}:`,o.message),e<3){let o=1e3*Math.pow(2,e-1)+1e3*Math.random();console.log(`‚è≥ Esperando ${Math.round(o)}ms antes del siguiente intento...`),await new Promise(e=>setTimeout(e,o))}}throw Error("WooCommerce no disponible despu\xe9s de todos los reintentos")}async refreshInBackground(){if(!this.isRefreshing){this.isRefreshing=!0;try{await this.fetchFromAPI()}catch(e){console.error("‚ùå Error refrescando cach\xe9 en segundo plano:",e)}finally{this.isRefreshing=!1}}}clear(){this.cache.clear(),this.lastFetch=null}}let a=new r},16605:(e,o,t)=>{t.d(o,{$g:()=>a,_z:()=>s,vf:()=>n});let r=e=>{let o;return e&&"Consultar"!==e?isNaN(o="string"==typeof e?parseFloat(e.replace(/[^\d.-]/g,"")):e)||o<=0?0:(o<1e4&&o>=50&&(o*=1e3),o<5e4&&o>=10&&("string"==typeof e?parseFloat(e.replace(/[^\d.-]/g,"")):e)<100&&(o*=1e3),o):0},a=(e,o={})=>{let{currency:t="EUR",minimumFractionDigits:a=0,maximumFractionDigits:n=0,showCurrency:s=!0}=o,l=r(e);return 0===l?"Consultar precio":s?new Intl.NumberFormat("es-ES",{style:"currency",currency:t,minimumFractionDigits:a,maximumFractionDigits:n}).format(l):new Intl.NumberFormat("es-ES",{minimumFractionDigits:a,maximumFractionDigits:n}).format(l)},n=e=>r(e),s=e=>{let o=r(e);if(o<=0)return[];let t=[];return t.push({label:"5% menos",value:Math.round(.95*o),percentage:-5}),t.push({label:"10% menos",value:Math.round(.9*o),percentage:-10}),t.push({label:"15% menos",value:Math.round(.85*o),percentage:-15}),t.push({label:"Precio publicado",value:o,percentage:0}),t}},23927:(e,o,t)=>{t.d(o,{Bi:()=>m});var r=t(82015),a=t(15464);let n=new Map,s={defaultLimit:20,maxLimit:50,retryAttempts:3,retryDelay:1e3},l=[{id:"ejemplo-1",title:"Moderno Apartamento en Madrid Centro",description:"Hermoso apartamento completamente renovado en el coraz\xf3n de Madrid",price:45e4,source:"ejemplo",images:[{url:"https://placekitten.com/800/600",alt:"Apartamento Madrid Centro"}],features:{bedrooms:3,bathrooms:2,area:95},location:"Madrid Centro, Madrid",address:"Calle Gran V\xeda, Madrid",coordinates:{lat:40.4168,lng:-3.7038},createdAt:new Date().toISOString()},{id:"ejemplo-2",title:"\xc1tico con Terraza en Malasa\xf1a",description:"Espectacular \xe1tico con terraza privada en zona premium",price:68e4,source:"ejemplo",images:[{url:"https://placekitten.com/800/601",alt:"\xc1tico Malasa\xf1a"}],features:{bedrooms:2,bathrooms:2,area:110},location:"Malasa\xf1a, Madrid",address:"Calle Fuencarral, Madrid",coordinates:{lat:40.425,lng:-3.7033},createdAt:new Date().toISOString()},{id:"ejemplo-3",title:"Casa Familiar en Las Rozas",description:"Amplia casa unifamiliar con jard\xedn privado",price:75e4,source:"ejemplo",images:[{url:"https://placekitten.com/800/602",alt:"Casa Las Rozas"}],features:{bedrooms:4,bathrooms:3,area:180},location:"Las Rozas, Madrid",address:"Urbanizaci\xf3n El Cantizal, Las Rozas",coordinates:{lat:40.4922,lng:-3.8739},createdAt:new Date().toISOString()}],i=(e,o,t)=>`${t}_${e}_${o}`,c=e=>{let o=n.get(e);return o&&Date.now()-o.timestamp<3e5?o.data:(n.delete(e),null)},d=(e,o)=>{if(n.size>=100){let e=n.keys().next().value;n.delete(e)}n.set(e,{data:o,timestamp:Date.now()})},m=(e={})=>{let{page:o=1,limit:t=s.defaultLimit,source:m="all",autoLoad:p=!0,enableCache:u=!0}=e,[g,h]=(0,r.useState)([]),[f,y]=(0,r.useState)(!1),[w,C]=(0,r.useState)(null),[b,A]=(0,r.useState)({page:1,limit:s.defaultLimit,total:0,hasMore:!0,sources:{woocommerce:0,mongodb:0,ejemplo:0}}),M=(0,r.useRef)(null),$=(0,r.useRef)(null),E=(0,r.useRef)(!1),j=(0,r.useRef)(!1),D=(0,r.useCallback)(async(e=o,r=t,n=m,p={})=>{if(console.log(`[useProperties] loadProperties called. Page: ${e}, Limit: ${r}, Source: ${n}`),E.current)return console.log("[useProperties] Ya hay una carga en progreso, ignorando..."),[];let{append:g=!1,useCache:f=u}=p;M.current&&M.current.abort(),M.current=new AbortController;let w=`${e}_${r}_${n}_${Date.now()}`;$.current=w;let b=i(e,r,n);if(f){let o=c(b);if(o)return console.log(`üöÄ Cache hit: ${o.length} propiedades`),g?h(e=>[...e,...o]):h(o),A(t=>({...t,page:e,limit:r,total:o.length,sources:{woocommerce:o.filter(e=>"woocommerce"===e.source).length,mongodb:o.filter(e=>"mongodb"===e.source).length,ejemplo:o.filter(e=>"ejemplo"===e.source).length}})),o}E.current=!0,y(!0),C(null);let D=async(o=1)=>{try{console.log(`üîÑ Cargando propiedades: p\xe1gina=${e}, l\xedmite=${r}, fuente=${n}, intento=${o}`);let t=[],i=!1;if("all"===n){console.log("\uD83D\uDD04 Cargando de ambas fuentes: MongoDB y WooCommerce");let o=async()=>{try{console.log("\uD83D\uDD04 WooCommerce: Intento 1/3");let e=await a.d.getProperties();if(e&&e.length>0)return console.log(`‚úÖ WooCommerce: ${e.length} propiedades cargadas y cacheadas`),e;console.log("‚ö†Ô∏è Sin datos en cach\xe9, intentando refresh..."),console.log("\uD83D\uDD04 WooCommerce: Intento 1/3");let o=await a.d.getProperties(!0);return console.log(`‚úÖ WooCommerce: ${(o||[]).length} propiedades cargadas y cacheadas`),o||[]}catch(e){return console.error("‚ùå Error obteniendo WooCommerce del cach\xe9:",e.message),[]}};try{let o=await fetch(`/api/properties/sources/mongodb?page=${e}&limit=${Math.min(r,s.maxLimit)}`,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},signal:M.current.signal});if(o.ok){let e=await o.json();Array.isArray(e)&&e.length>0&&(console.log(`‚úÖ MongoDB: ${e.length} propiedades`),t.push(...e),i=!0)}}catch(e){console.warn("‚ö†Ô∏è MongoDB no disponible:",e.message)}try{let e=await o();Array.isArray(e)&&e.length>0&&(t.push(...e),i=!0)}catch(e){console.warn("‚ö†Ô∏è WooCommerce no disponible:",e.message)}}else if("mongodb"===n)try{let o=await fetch(`/api/properties/sources/mongodb?page=${e}&limit=${Math.min(r,s.maxLimit)}`,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},signal:M.current.signal});if(o.ok){let e=await o.json();Array.isArray(e)&&e.length>0&&(t=e,i=!0)}}catch(e){console.error("Error cargando MongoDB:",e)}else try{let e=await a.d.getProperties();Array.isArray(e)&&e.length>0&&(t=e,i=!0)}catch(e){console.error("Error cargando WooCommerce:",e)}if(i||0!==t.length||(console.log("\uD83C\uDFE0 No hay propiedades reales disponibles, usando ejemplos"),t=l.slice(0,r)),$.current!==w)return void console.log("‚ö†Ô∏è Petici\xf3n obsoleta, ignorando...");return f&&i&&t.length>0&&d(b,t),g?h(e=>[...e,...t].filter((e,o,t)=>o===t.findIndex(o=>o.id===e.id))):h(t),A(o=>({...o,page:e,limit:r,total:t.length,hasMore:t.length===r,sources:{woocommerce:t.filter(e=>"woocommerce"===e.source).length,mongodb:t.filter(e=>"mongodb"===e.source).length,ejemplo:t.filter(e=>"ejemplo"===e.source).length}})),console.log(`‚úÖ Propiedades cargadas: ${t.length} elementos (${i?"reales":"ejemplos"})`),t}catch(e){if("AbortError"===e.name)return void console.log("\uD83D\uDEAB Petici\xf3n cancelada");if(console.error(`‚ùå Error en intento ${o}:`,e.message),o<s.retryAttempts){let e=s.retryDelay*Math.pow(2,o-1);return console.log(`‚è≥ Reintentando en ${e}ms...`),await new Promise(o=>setTimeout(o,e)),D(o+1)}return console.log("\uD83C\uDFE0 Usando propiedades de ejemplo debido a errores"),l.slice(0,r)}};try{let e=await D();return j.current=!0,e||[]}catch(o){console.error("\uD83D\uDCA5 Error final:",o.message),j.current=!0,C(o.message),console.log("\uD83C\uDFE0 Usando propiedades de ejemplo como fallback final");let e=l.slice(0,r);return h(e),A(o=>({...o,total:e.length,sources:{woocommerce:0,mongodb:0,ejemplo:e.length}})),e}finally{E.current=!1,y(!1)}},[o,t,m,u]),P=(0,r.useCallback)(async()=>{if(!f&&b.hasMore)return D(b.page+1,t,m,{append:!0})},[f,b.hasMore,b.page,t,m,D]),v=(0,r.useCallback)(async()=>{let e=i(o,t,m);return n.delete(e),j.current=!1,h([]),D(o,t,m,{useCache:!1})},[o,t,m,D]),I=(0,r.useCallback)(async e=>{let{page:o=1,limit:r=t,source:a=m}=e;return h([]),A(e=>({...e,page:o,limit:r,hasMore:!0})),D(o,r,a)},[t,m,D]);return(0,r.useEffect)(()=>(console.log("[useProperties] useEffect for autoLoad triggered. autoLoad:",p,"hasAttempted:",j.current),!p||j.current||E.current||(console.log("[useProperties] Calling loadProperties from useEffect"),D()),()=>{M.current&&M.current.abort()}),[p]),(0,r.useEffect)(()=>{let e=setInterval(()=>{let e=Date.now();for(let[o,t]of n.entries())e-t.timestamp>3e5&&n.delete(o)},3e5);return()=>clearInterval(e)},[]),{properties:g,loading:f,error:w,meta:b,loadProperties:D,loadMore:P,refresh:v,changeFilters:I,clearCache:()=>n.clear(),getCacheSize:()=>n.size}}}};