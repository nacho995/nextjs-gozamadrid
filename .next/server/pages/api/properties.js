"use strict";(()=>{var e={};e.id=4764,e.ids=[4764],e.modules={1428:e=>{e.exports=import("axios")},8667:(e,o)=>{Object.defineProperty(o,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},33480:(e,o,r)=>{e.exports=r(75600)},47746:(e,o,r)=>{r.a(e,async(e,t)=>{try{r.r(o),r.d(o,{default:()=>i,loadRealProperties:()=>p});var a=r(1428),s=r(86391),n=e([a,s]);[a,s]=n.then?(await n)():n;let d={endpoints:[process.env.WC_API_URL||"https://wordpress.realestategozamadrid.com/wp-json/wc/v3"],credentials:{key:process.env.WC_CONSUMER_KEY,secret:process.env.WC_CONSUMER_SECRET},connection:{timeout:8e3,maxRetries:1,retryDelay:500}};async function l(e){try{let o=await s.kv.get(e);if(o)return console.log(`ðŸš€ Vercel KV Cache HIT para la clave: ${e}`),o}catch(o){console.error(`âŒ Error leyendo de Vercel KV para ${e}:`,o.message)}return console.log(`ðŸ’¨ Vercel KV Cache MISS para la clave: ${e}`),null}async function c(e,o){try{await s.kv.set(e,o,{ex:1800}),console.log(`âœ… Datos cacheados en Vercel KV para la clave: ${e} con TTL: 1800s`)}catch(o){console.error(`âŒ Error escribiendo en Vercel KV para ${e}:`,o.message)}}let p=async(e=1,o=5)=>{let r=`woo_props_page_${e}_limit_${o}`;console.log(`ðŸ  Cargando propiedades SOLO desde cach\xe9 - P\xe1gina: ${e}, L\xedmite: ${o}`);let t=await l(r);if(t)return console.log(`âœ… Cache HIT espec\xedfico: ${t.length} propiedades`),t;let a=await l("woo_props_all");if(a&&Array.isArray(a)){let t=(e-1)*o,s=a.slice(t,t+o);return console.log(`âœ… Cache HIT general: ${s.length} propiedades (de ${a.length} totales)`),s.length>0&&c(r,s).catch(e=>console.error("âš ï¸ Error guardando cach\xe9 espec\xedfico:",e.message)),s}return console.log(`ðŸ’¨ Sin datos en cach\xe9. El cron job precargar\xe1 los datos pronto.`),[]};async function i(e,o){let r=Date.now(),{limit:t=5,page:a=1}=e.query;if(console.log(`ðŸ  API Handler con Vercel KV iniciada - P\xe1gina: ${a}, L\xedmite: ${t}`),!d.credentials.key||!d.credentials.secret)return console.warn("âš ï¸ Sin credenciales WooCommerce"),o.setHeader("X-WooCommerce-Status","no-credentials"),o.status(200).json([]);let s=!!(process.env.KV_REST_API_URL&&process.env.KV_REST_API_TOKEN);console.log(`ðŸ”‘ Vercel KV disponible: ${s}`),o.setHeader("Cache-Control","s-maxage=60, stale-while-revalidate=300"),o.setHeader("Content-Type","application/json");try{let e=await p(parseInt(a),parseInt(t)),s=Date.now()-r;return console.log(`ðŸŽ‰ \xc9XITO: ${e.length} propiedades en ${s}ms`),o.setHeader("X-WooCommerce-Status","success"),o.setHeader("X-Response-Time",`${s}ms`),o.setHeader("X-Cache-Type","vercel-kv"),o.status(200).json(e)}catch(t){let e=Date.now()-r;return console.error(`ðŸ’¥ ERROR: ${t.message} en ${e}ms`),o.setHeader("X-WooCommerce-Status","error"),o.setHeader("X-Response-Time",`${e}ms`),o.status(200).json([])}}t()}catch(e){t(e)}})},67839:(e,o,r)=>{r.a(e,async(e,t)=>{try{r.r(o),r.d(o,{config:()=>d,default:()=>i,routeModule:()=>p});var a=r(33480),s=r(8667),n=r(86435),l=r(85552),c=e([l]);l=(c.then?(await c)():c)[0];let i=(0,n.M)(l,"default"),d=(0,n.M)(l,"config"),p=new a.PagesAPIRouteModule({definition:{kind:s.A.PAGES_API,page:"/api/properties",pathname:"/api/properties",bundlePath:"",filename:""},userland:l});t()}catch(e){t(e)}})},75600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},85552:(e,o,r)=>{r.a(e,async(e,t)=>{try{r.r(o),r.d(o,{default:()=>l});var a=r(1428),s=r(47746),n=e([a,s]);[a,s]=n.then?(await n)():n;let c={mongodb:{timeout:8e3,maxRetries:3}},i=new Map,d=e=>{let o=i.get(e);return o&&Date.now()-o.timestamp<3e5?o.data:(i.delete(e),null)},p=(e,o)=>{i.set(e,{data:o,timestamp:Date.now()})},u=async(e=20)=>{console.log(`ðŸƒ Cargando propiedades REALES de MongoDB (l\xedmite: ${e})`);try{let o=await fetch(`${process.env.NEXT_PUBLIC_API_URL||"http://localhost:3000"}/api/properties/sources/mongodb`,{method:"GET",headers:{"Content-Type":"application/json"},timeout:c.mongodb.timeout});if(!o.ok)throw Error(`MongoDB API error: ${o.status}`);let r=await o.json(),t=Array.isArray(r)?r:[];return console.log(`âœ… MongoDB: ${t.length} propiedades reales cargadas`),t.slice(0,e)}catch(e){return console.error(`âŒ Error cargando MongoDB:`,e.message),[]}},m=async(e=50)=>{console.log(`ðŸ›’ Cargando propiedades REALES de WooCommerce (l\xedmite: ${e})`);try{let o=await (0,s.loadRealProperties)(1,e);return console.log(`âœ… WooCommerce: ${o.length} propiedades reales cargadas`),o}catch(e){return console.error(`âŒ Error cargando WooCommerce:`,e.message),[]}},g=e=>{let o=new Set;return e.filter(e=>!o.has(e.id)&&(o.add(e.id),!0))};async function l(e,o){let r=Date.now(),{limit:t=40}=e.query,a=parseInt(t);console.log(`ðŸ  API COMBINADA PROPIEDADES REALES iniciada (l\xedmite: ${a})`),o.setHeader("Cache-Control","s-maxage=300, stale-while-revalidate=60"),o.setHeader("Content-Type","application/json");let s=`combined_real_${a}`,n=d(s);if(n){let e=Date.now()-r;return console.log(`ðŸš€ Cache hit: ${n.length} propiedades reales en ${e}ms`),o.status(200).json(n)}try{let[e,t]=await Promise.allSettled([u(Math.ceil(a/2)),m(Math.min(a,30))]),n="fulfilled"===e.status?e.value:[],l="fulfilled"===t.status?t.value:[],c=[...n,...l],i=g(c).slice(0,a),d=Date.now()-r;if(i.length>0)return p(s,i),console.log(`ðŸŽ‰ \xc9XITO: ${i.length} propiedades REALES combinadas en ${d}ms`),console.log(`ðŸ“Š Distribuci\xf3n: MongoDB=${n.length}, WooCommerce=${l.length}`),o.status(200).json(i);return console.error(`ðŸ’¥ ERROR: No hay propiedades reales disponibles despu\xe9s de ${d}ms`),o.status(503).json({error:"Propiedades no disponibles",message:"No hay propiedades reales disponibles en este momento. Int\xe9ntelo de nuevo en unos minutos.",sources:{mongodb:"fulfilled"===e.status?"OK":"ERROR",woocommerce:"fulfilled"===t.status?"OK":"ERROR"},timestamp:new Date().toISOString(),duration:`${d}ms`})}catch(t){let e=Date.now()-r;return console.error(`ðŸ’¥ ERROR CR\xcdTICO despu\xe9s de ${e}ms:`,t.message),o.status(500).json({error:"Error del servidor",message:"Error interno al cargar propiedades reales.",timestamp:new Date().toISOString(),duration:`${e}ms`})}}t()}catch(e){t(e)}})},86391:e=>{e.exports=import("@vercel/kv")},86435:(e,o)=>{Object.defineProperty(o,"M",{enumerable:!0,get:function(){return function e(o,r){return r in o?o[r]:"then"in o&&"function"==typeof o.then?o.then(o=>e(o,r)):"function"==typeof o&&"default"===r?o:void 0}}})}};var o=require("../../webpack-api-runtime.js");o.C(e);var r=o(o.s=67839);module.exports=r})();