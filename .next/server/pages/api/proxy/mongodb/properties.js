"use strict";(()=>{var e={};e.id=3734,e.ids=[3734],e.modules={8667:(e,o)=>{Object.defineProperty(o,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},33480:(e,o,r)=>{e.exports=r(75600)},75600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},84163:(e,o,r)=>{r.r(o),r.d(o,{config:()=>c,default:()=>d,routeModule:()=>p});var t={};r.r(t),r.d(t,{default:()=>l});var a=r(33480),n=r(8667),s=r(86435);let i=async(e,o={},r=3)=>{let t;for(let a=0;a<r;a++)try{let r=15e3*(a+1),t=new AbortController,n=setTimeout(()=>t.abort(),r);console.log(`[MongoDB Proxy] Intento ${a+1} para ${e}`);let s=await fetch(e,{...o,signal:t.signal,headers:{Accept:"application/json","Content-Type":"application/json","User-Agent":"GozaMadrid/1.0 (Node.js)",...o.headers}});if(clearTimeout(n),!s.ok)throw Error(`HTTP error! status: ${s.status}`);try{return await s.json()}catch(o){console.error(`[MongoDB Proxy] Error al parsear JSON: ${o.message}`);let e=await s.text();throw console.log(`[MongoDB Proxy] Respuesta como texto: ${e.substring(0,200)}...`),Error(`Respuesta no es JSON v\xe1lido: ${o.message}`)}}catch(e){if(console.error(`[MongoDB Proxy] Error en intento ${a+1}:`,e),t=e,a<r-1){let e=Math.min(1e3*Math.pow(2,a),8e3);await new Promise(o=>setTimeout(o,e))}}throw t};async function l(e,o){if(o.setHeader("Access-Control-Allow-Credentials","true"),o.setHeader("Access-Control-Allow-Origin","*"),o.setHeader("Access-Control-Allow-Methods","GET,OPTIONS,HEAD"),o.setHeader("Access-Control-Allow-Headers","Accept, Content-Type, Authorization"),o.setHeader("Access-Control-Max-Age","86400"),"OPTIONS"===e.method)return o.status(200).end();if("GET"!==e.method)return o.status(405).json({error:"M\xe9todo no permitido"});try{let r="https://nextjs-gozamadrid-qrfk.onrender.com/api/properties";console.log("[MongoDB Proxy] Iniciando petici\xf3n a:",r);let t=new URL(r);e.query&&Object.keys(e.query).forEach(o=>{"slug"!==o&&t.searchParams.append(o,e.query[o])});try{let e=await i(t.toString(),{headers:{Accept:"application/json","Content-Type":"application/json",Origin:"https://www.realestategozamadrid.com",Referer:"https://www.realestategozamadrid.com/"}});if(Array.isArray(e)){let r=e.map(e=>({...e,source:"mongodb",type:"mongodb"}));return console.log(`[MongoDB Proxy] Obtenidas ${r.length} propiedades`),o.setHeader("Cache-Control","s-maxage=300, stale-while-revalidate"),o.status(200).json(r)}if(e&&"object"==typeof e){if(e.properties&&Array.isArray(e.properties)){let r=e.properties.map(e=>({...e,source:"mongodb",type:"mongodb"}));return console.log(`[MongoDB Proxy] Obtenidas ${r.length} propiedades desde data.properties`),o.setHeader("Cache-Control","s-maxage=300, stale-while-revalidate"),o.status(200).json(r)}return console.log("[MongoDB Proxy] Respuesta es un objeto, devolviendo tal cual"),o.setHeader("Cache-Control","s-maxage=300, stale-while-revalidate"),o.status(200).json(e)}return console.error("[MongoDB Proxy] Formato de respuesta desconocido:",typeof e),o.status(500).json({error:"Formato de respuesta desconocido",details:typeof e,sample:JSON.stringify(e).substring(0,200)+"..."})}catch(e){console.error("[MongoDB Proxy] Error obteniendo datos:",e),console.log("[MongoDB Proxy] Primer intento fall\xf3, intentando con URL alternativa...");try{let e=await i("https://nextjs-gozamadrid-qrfk.onrender.com/api/properties/sources/mongodb",{headers:{Accept:"application/json","Content-Type":"application/json",Origin:"https://www.realestategozamadrid.com",Referer:"https://www.realestategozamadrid.com/"}});if(Array.isArray(e)){let r=e.map(e=>({...e,source:"mongodb",type:"mongodb"}));return console.log(`[MongoDB Proxy] (Alternativa) Obtenidas ${r.length} propiedades`),o.setHeader("Cache-Control","s-maxage=300, stale-while-revalidate"),o.status(200).json(r)}throw Error("Ambos endpoints fallaron")}catch(o){throw console.error("[MongoDB Proxy] Error con URL alternativa:",o),e}}}catch(e){return console.error("[MongoDB Proxy] Error general:",e),console.log("[MongoDB Proxy] Devolviendo array vac\xedo como fallback"),o.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),o.status(200).json([])}}let d=(0,s.M)(t,"default"),c=(0,s.M)(t,"config"),p=new a.PagesAPIRouteModule({definition:{kind:n.A.PAGES_API,page:"/api/proxy/mongodb/properties",pathname:"/api/proxy/mongodb/properties",bundlePath:"",filename:""},userland:t})},86435:(e,o)=>{Object.defineProperty(o,"M",{enumerable:!0,get:function(){return function e(o,r){return r in o?o[r]:"then"in o&&"function"==typeof o.then?o.then(o=>e(o,r)):"function"==typeof o&&"default"===r?o:void 0}}})}};var o=require("../../../../webpack-api-runtime.js");o.C(e);var r=o(o.s=84163);module.exports=r})();