"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7955],{30333:(e,o,t)=>{t.d(o,{Bi:()=>m});var a=t(14232),r=t(87852);let n=new Map,c={defaultLimit:20,maxLimit:50,retryAttempts:3,retryDelay:1e3},l=[{id:"ejemplo-1",title:"Moderno Apartamento en Madrid Centro",description:"Hermoso apartamento completamente renovado en el coraz\xf3n de Madrid",price:45e4,source:"ejemplo",images:[{url:"https://placekitten.com/800/600",alt:"Apartamento Madrid Centro"}],features:{bedrooms:3,bathrooms:2,area:95},location:"Madrid Centro, Madrid",address:"Calle Gran V\xeda, Madrid",coordinates:{lat:40.4168,lng:-3.7038},createdAt:new Date().toISOString()},{id:"ejemplo-2",title:"\xc1tico con Terraza en Malasa\xf1a",description:"Espectacular \xe1tico con terraza privada en zona premium",price:68e4,source:"ejemplo",images:[{url:"https://placekitten.com/800/601",alt:"\xc1tico Malasa\xf1a"}],features:{bedrooms:2,bathrooms:2,area:110},location:"Malasa\xf1a, Madrid",address:"Calle Fuencarral, Madrid",coordinates:{lat:40.425,lng:-3.7033},createdAt:new Date().toISOString()},{id:"ejemplo-3",title:"Casa Familiar en Las Rozas",description:"Amplia casa unifamiliar con jard\xedn privado",price:75e4,source:"ejemplo",images:[{url:"https://placekitten.com/800/602",alt:"Casa Las Rozas"}],features:{bedrooms:4,bathrooms:3,area:180},location:"Las Rozas, Madrid",address:"Urbanizaci\xf3n El Cantizal, Las Rozas",coordinates:{lat:40.4922,lng:-3.8739},createdAt:new Date().toISOString()}],s=(e,o,t)=>"".concat(t,"_").concat(e,"_").concat(o),i=e=>{let o=n.get(e);return o&&Date.now()-o.timestamp<3e5?o.data:(n.delete(e),null)},d=(e,o)=>{if(n.size>=100){let e=n.keys().next().value;n.delete(e)}n.set(e,{data:o,timestamp:Date.now()})},m=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{page:o=1,limit:t=c.defaultLimit,source:m="all",autoLoad:u=!0,enableCache:p=!0}=e,[g,h]=(0,a.useState)([]),[f,y]=(0,a.useState)(!1),[w,C]=(0,a.useState)(null),[b,A]=(0,a.useState)({page:1,limit:c.defaultLimit,total:0,hasMore:!0,sources:{woocommerce:0,mongodb:0,ejemplo:0}}),M=(0,a.useRef)(null),D=(0,a.useRef)(null),E=(0,a.useRef)(!1),v=(0,a.useRef)(!1),j=(0,a.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:o,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:m,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(console.log("[useProperties] loadProperties called. Page: ".concat(e,", Limit: ").concat(a,", Source: ").concat(n)),E.current)return console.log("[useProperties] Ya hay una carga en progreso, ignorando..."),[];let{append:g=!1,useCache:f=p}=u;M.current&&M.current.abort(),M.current=new AbortController;let w="".concat(e,"_").concat(a,"_").concat(n,"_").concat(Date.now());D.current=w;let b=s(e,a,n);if(f){let o=i(b);if(o)return console.log("\uD83D\uDE80 Cache hit: ".concat(o.length," propiedades")),g?h(e=>[...e,...o]):h(o),A(t=>({...t,page:e,limit:a,total:o.length,sources:{woocommerce:o.filter(e=>"woocommerce"===e.source).length,mongodb:o.filter(e=>"mongodb"===e.source).length,ejemplo:o.filter(e=>"ejemplo"===e.source).length}})),o}E.current=!0,y(!0),C(null);let j=async function(){let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;try{console.log("\uD83D\uDD04 Cargando propiedades: p\xe1gina=".concat(e,", l\xedmite=").concat(a,", fuente=").concat(n,", intento=").concat(o));let t=[],s=!1;if("all"===n){console.log("\uD83D\uDD04 Cargando de ambas fuentes: MongoDB y WooCommerce");let o=async()=>{try{console.log("\uD83D\uDD04 WooCommerce: Intento 1/3");let e=await r.d.getProperties();if(e&&e.length>0)return console.log("✅ WooCommerce: ".concat(e.length," propiedades cargadas y cacheadas")),e;console.log("⚠️ Sin datos en cach\xe9, intentando refresh..."),console.log("\uD83D\uDD04 WooCommerce: Intento 1/3");let o=await r.d.getProperties(!0);return console.log("✅ WooCommerce: ".concat((o||[]).length," propiedades cargadas y cacheadas")),o||[]}catch(e){return console.error("❌ Error obteniendo WooCommerce del cach\xe9:",e.message),[]}};try{let o=await fetch("/api/properties/sources/mongodb?page=".concat(e,"&limit=").concat(Math.min(a,c.maxLimit)),{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},signal:M.current.signal});if(o.ok){let e=await o.json();Array.isArray(e)&&e.length>0&&(console.log("✅ MongoDB: ".concat(e.length," propiedades")),t.push(...e),s=!0)}}catch(e){console.warn("⚠️ MongoDB no disponible:",e.message)}try{let e=await o();Array.isArray(e)&&e.length>0&&(t.push(...e),s=!0)}catch(e){console.warn("⚠️ WooCommerce no disponible:",e.message)}}else if("mongodb"===n)try{let o=await fetch("/api/properties/sources/mongodb?page=".concat(e,"&limit=").concat(Math.min(a,c.maxLimit)),{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},signal:M.current.signal});if(o.ok){let e=await o.json();Array.isArray(e)&&e.length>0&&(t=e,s=!0)}}catch(e){console.error("Error cargando MongoDB:",e)}else try{let e=await r.d.getProperties();Array.isArray(e)&&e.length>0&&(t=e,s=!0)}catch(e){console.error("Error cargando WooCommerce:",e)}if(s||0!==t.length||(console.log("\uD83C\uDFE0 No hay propiedades reales disponibles, usando ejemplos"),t=l.slice(0,a)),D.current!==w)return void console.log("⚠️ Petici\xf3n obsoleta, ignorando...");return f&&s&&t.length>0&&d(b,t),g?h(e=>[...e,...t].filter((e,o,t)=>o===t.findIndex(o=>o.id===e.id))):h(t),A(o=>({...o,page:e,limit:a,total:t.length,hasMore:t.length===a,sources:{woocommerce:t.filter(e=>"woocommerce"===e.source).length,mongodb:t.filter(e=>"mongodb"===e.source).length,ejemplo:t.filter(e=>"ejemplo"===e.source).length}})),console.log("✅ Propiedades cargadas: ".concat(t.length," elementos (").concat(s?"reales":"ejemplos",")")),t}catch(e){if("AbortError"===e.name)return void console.log("\uD83D\uDEAB Petici\xf3n cancelada");if(console.error("❌ Error en intento ".concat(o,":"),e.message),o<c.retryAttempts){let e=c.retryDelay*Math.pow(2,o-1);return console.log("⏳ Reintentando en ".concat(e,"ms...")),await new Promise(o=>setTimeout(o,e)),j(o+1)}return console.log("\uD83C\uDFE0 Usando propiedades de ejemplo debido a errores"),l.slice(0,a)}};try{let e=await j();return v.current=!0,e||[]}catch(o){console.error("\uD83D\uDCA5 Error final:",o.message),v.current=!0,C(o.message),console.log("\uD83C\uDFE0 Usando propiedades de ejemplo como fallback final");let e=l.slice(0,a);return h(e),A(o=>({...o,total:e.length,sources:{woocommerce:0,mongodb:0,ejemplo:e.length}})),e}finally{E.current=!1,y(!1)}},[o,t,m,p]),P=(0,a.useCallback)(async()=>{if(!f&&b.hasMore)return j(b.page+1,t,m,{append:!0})},[f,b.hasMore,b.page,t,m,j]),I=(0,a.useCallback)(async()=>{let e=s(o,t,m);return n.delete(e),v.current=!1,h([]),j(o,t,m,{useCache:!1})},[o,t,m,j]),k=(0,a.useCallback)(async e=>{let{page:o=1,limit:a=t,source:r=m}=e;return h([]),A(e=>({...e,page:o,limit:a,hasMore:!0})),j(o,a,r)},[t,m,j]);return(0,a.useEffect)(()=>(console.log("[useProperties] useEffect for autoLoad triggered. autoLoad:",u,"hasAttempted:",v.current),!u||v.current||E.current||(console.log("[useProperties] Calling loadProperties from useEffect"),j()),()=>{M.current&&M.current.abort()}),[u]),(0,a.useEffect)(()=>{let e=setInterval(()=>{let e=Date.now();for(let[o,t]of n.entries())e-t.timestamp>3e5&&n.delete(o)},3e5);return()=>clearInterval(e)},[]),{properties:g,loading:f,error:w,meta:b,loadProperties:j,loadMore:P,refresh:I,changeFilters:k,clearCache:()=>n.clear(),getCacheSize:()=>n.size}}},87375:(e,o,t)=>{t.d(o,{$g:()=>r,_z:()=>c,vf:()=>n});let a=e=>{let o;return e&&"Consultar"!==e?isNaN(o="string"==typeof e?parseFloat(e.replace(/[^\d.-]/g,"")):e)||o<=0?0:(o<1e4&&o>=50&&(o*=1e3),o<5e4&&o>=10&&("string"==typeof e?parseFloat(e.replace(/[^\d.-]/g,"")):e)<100&&(o*=1e3),o):0},r=function(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{currency:t="EUR",minimumFractionDigits:r=0,maximumFractionDigits:n=0,showCurrency:c=!0}=o,l=a(e);return 0===l?"Consultar precio":c?new Intl.NumberFormat("es-ES",{style:"currency",currency:t,minimumFractionDigits:r,maximumFractionDigits:n}).format(l):new Intl.NumberFormat("es-ES",{minimumFractionDigits:r,maximumFractionDigits:n}).format(l)},n=e=>a(e),c=e=>{let o=a(e);if(o<=0)return[];let t=[];return t.push({label:"5% menos",value:Math.round(.95*o),percentage:-5}),t.push({label:"10% menos",value:Math.round(.9*o),percentage:-10}),t.push({label:"15% menos",value:Math.round(.85*o),percentage:-15}),t.push({label:"Precio publicado",value:o,percentage:0}),t}},87852:(e,o,t)=>{t.d(o,{d:()=>r});class a{async getProperties(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],o=Date.now(),t=this.cache.get("woocommerce_properties");if(t&&!e){let e=o-t.timestamp;if(e<this.CACHE_DURATION)return console.log("✅ WooCommerce: Devolviendo datos del cach\xe9 (frescos)"),t.data;if(e<this.STALE_DURATION)return console.log("⚡ WooCommerce: Devolviendo datos del cach\xe9 (stale) y refrescando en segundo plano"),this.refreshInBackground(),t.data}try{return await this.fetchFromAPI()}catch(e){if(t)return console.log("⚠️ WooCommerce: Error en fetch, devolviendo datos antiguos del cach\xe9"),t.data;return console.error("❌ WooCommerce: Sin cach\xe9 y sin conexi\xf3n"),[]}}async fetchFromAPI(){for(let e=1;e<=3;e++)try{console.log("\uD83D\uDD04 WooCommerce: Intento ".concat(e,"/").concat(3));let o=new AbortController,t=setTimeout(()=>o.abort(),1e4),a=await fetch("/api/properties/sources/woocommerce?limit=100",{signal:o.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(t),!a.ok)throw Error("HTTP ".concat(a.status));let r=await a.json();return this.cache.set("woocommerce_properties",{data:Array.isArray(r)?r:[],timestamp:Date.now()}),console.log("✅ WooCommerce: ".concat(r.length," propiedades cargadas y cacheadas")),r}catch(o){if(console.error("❌ WooCommerce: Error en intento ".concat(e,":"),o.message),e<3){let o=1e3*Math.pow(2,e-1)+1e3*Math.random();console.log("⏳ Esperando ".concat(Math.round(o),"ms antes del siguiente intento...")),await new Promise(e=>setTimeout(e,o))}}throw Error("WooCommerce no disponible despu\xe9s de todos los reintentos")}async refreshInBackground(){if(!this.isRefreshing){this.isRefreshing=!0;try{await this.fetchFromAPI()}catch(e){console.error("❌ Error refrescando cach\xe9 en segundo plano:",e)}finally{this.isRefreshing=!1}}}clear(){this.cache.clear(),this.lastFetch=null}constructor(){this.cache=new Map,this.lastFetch=null,this.isRefreshing=!1,this.CACHE_DURATION=3e5,this.STALE_DURATION=36e5}}let r=new a}}]);