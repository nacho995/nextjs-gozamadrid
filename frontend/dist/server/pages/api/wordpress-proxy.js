"use strict";(()=>{var e={};e.id=647,e.ids=[647],e.modules={10309:(e,r)=>{Object.defineProperty(r,"A",{enumerable:!0,get:function(){return o}});var o=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},15113:(e,r)=>{Object.defineProperty(r,"M",{enumerable:!0,get:function(){return function e(r,o){return o in r?r[o]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,o)):"function"==typeof r&&"default"===o?r:void 0}}})},69265:(e,r,o)=>{o.r(r),o.d(r,{config:()=>p,default:()=>u,routeModule:()=>P});var t={};o.r(t),o.d(t,{default:()=>c});var s=o(76438),a=o(10309),n=o(15113);let i=10,l=e=>new Promise(r=>setTimeout(r,e)),d=async(e,r,o=i,t=1)=>{try{let s=new AbortController,a=setTimeout(()=>s.abort(),18e4),n=await fetch(e,{...r,signal:s.signal,headers:{...r.headers,"User-Agent":"Mozilla/5.0 (compatible; GozaMadridBot/1.0)",Accept:"application/json","Cache-Control":"public, max-age=60, stale-while-revalidate=600",Pragma:void 0,Expires:void 0}});if(clearTimeout(a),(503===n.status||502===n.status||504===n.status||404===n.status)&&o>0){let s=Math.min(2e3*Math.pow(2,t-1),6e4);return console.log(`[WordPress Proxy] Error ${n.status} - Reintentando (${o} intentos restantes) despu\xe9s de ${s}ms...`),await l(s),d(e,r,o-1,t+1)}return n}catch(s){if("AbortError"===s.name){if(console.error("[WordPress Proxy] Timeout - La solicitud tard\xf3 demasiado"),o>0)return console.log(`[WordPress Proxy] Reintentando despu\xe9s del timeout...`),d(e,r,o-1,t+1);throw Error("Timeout - La solicitud tard\xf3 demasiado")}if(o>0){let a=Math.min(2e3*Math.pow(2,t-1),6e4);return console.log(`[WordPress Proxy] Error en la petici\xf3n: ${s.message} - Reintentando (${o} intentos restantes) despu\xe9s de ${a}ms...`),await l(a),d(e,r,o-1,t+1)}throw s}};async function c(e,r){if(r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Allow-Methods","GET, OPTIONS"),r.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),"OPTIONS"===e.method)return r.status(200).end();r.setHeader("Cache-Control","public, max-age=60, stale-while-revalidate=600");let{path:o,endpoint:t,...s}=e.query;console.log("WordPress Proxy - Par\xe1metros recibidos:",{path:o,endpoint:t,queryParams:s});let a="",n="";if(s.per_page||(s.per_page=100),"wp"===t){a="https://wordpress-1430059-5339263.cloudwaysapps.com/wp-json/wp/v2",n=`${a}/${o||"posts"}`;let e=Object.entries(s).map(([e,r])=>`${e}=${encodeURIComponent(r)}`).join("&");e&&(n+=`?${e}`)}else a="https://wordpress-1430059-5339263.cloudwaysapps.com/wp-json/wc/v3",n=`${a}/${o||"products"}?consumer_key=ck_d69e61427264a7beea70ca9ee543b45dd00cae85&consumer_secret=cs_a1757851d6db34bf9fb669c3ce6ef5a0dc855b5e`,Object.entries(s).forEach(([e,r])=>{n+=`&${e}=${encodeURIComponent(r)}`});console.log("WordPress Proxy - URL construida:",n);try{let e=await d(n,{headers:{"Cache-Control":"public, max-age=60, stale-while-revalidate=600",Pragma:void 0,Expires:void 0,"User-Agent":"Mozilla/5.0 (compatible; GozaMadridBot/1.0)",Accept:"application/json"}});console.log("WordPress Proxy - Respuesta recibida:",{status:e.status,statusText:e.statusText,headers:Object.fromEntries([...e.headers.entries()])});let o=parseInt(e.headers.get("X-WP-TotalPages")||"1"),t=parseInt(e.headers.get("X-WP-Total")||"0");if(!e.ok){if(console.error(`[WordPress Proxy] Error en la respuesta despu\xe9s de ${i} intentos: ${e.status} ${e.statusText}`),503===e.status||502===e.status||404===e.status)return console.log("[WordPress Proxy] Servicio no disponible despu\xe9s de todos los reintentos, devolviendo array vac\xedo"),r.status(200).json([]);try{let r=await e.text();console.error("WordPress Proxy - Cuerpo del error:",r)}catch(e){console.error("WordPress Proxy - No se pudo leer el cuerpo del error")}return r.status(e.status).json({error:`Error al obtener datos de WordPress: ${e.status}`,message:e.statusText})}let a=await e.json();if(a=Array.isArray(a)?a:[a],o>1&&!s.page){console.log(`WordPress Proxy - Obteniendo todas las p\xe1ginas (${o} p\xe1ginas en total)`);let e=Array.from({length:o-1},(e,r)=>r+2).map(async e=>{let r=`${n}${n.includes("?")?"&":"?"}page=${e}`,o=await d(r,{headers:{"Cache-Control":"public, max-age=60, stale-while-revalidate=600",Pragma:void 0,Expires:void 0,"User-Agent":"Mozilla/5.0 (compatible; GozaMadridBot/1.0)",Accept:"application/json"}});if(!o.ok)return console.error(`Error al obtener p\xe1gina ${e}: ${o.status}`),[];let t=await o.json();return Array.isArray(t)?t:[t]});(await Promise.allSettled(e)).forEach(e=>{"fulfilled"===e.status?a.push(...e.value):console.error("Error al obtener p\xe1gina adicional:",e.reason)})}return console.log(`WordPress Proxy - Total de elementos obtenidos: ${a.length}`),t&&r.setHeader("X-WP-Total",t),o&&r.setHeader("X-WP-TotalPages",o),r.status(200).json(a)}catch(e){return console.error("Error en el proxy de WordPress:",e),console.log("WordPress Proxy - Error irrecuperable, devolviendo array vac\xedo"),r.status(200).json([])}}let u=(0,n.M)(t,"default"),p=(0,n.M)(t,"config"),P=new s.PagesAPIRouteModule({definition:{kind:a.A.PAGES_API,page:"/api/wordpress-proxy",pathname:"/api/wordpress-proxy",bundlePath:"",filename:""},userland:t})},75600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},76438:(e,r,o)=>{e.exports=o(75600)}};var r=require("../../webpack-api-runtime.js");r.C(e);var o=r(r.s=69265);module.exports=o})();